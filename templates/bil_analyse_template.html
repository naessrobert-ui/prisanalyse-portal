<!DOCTYPE html>
<html lang="nb">
<head>
    <meta charset="UTF-8">
    <title>{{ tittel }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { padding: 1rem; background-color: #f8f9fa; }
        label { font-weight: bold; margin-bottom: 0.5rem; display: block; }
        .card-header { font-weight: bold; }
        #output-bil-tabell { font-size: 0.8rem; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.7); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .form-control, .form-select { font-size: 0.9rem; }
        .input-group-text { font-size: 0.8rem; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-spinner"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Laster...</span></div></div>

    <div class="container-fluid">
        <a href="/" class="btn btn-secondary mb-3">← Tilbake til forsiden</a>
        <h1 class="text-center my-4">{{ tittel }}</h1>

        <div class="alert alert-info">
            <h4 class="alert-heading">Velkommen!</h4>
            <p class="mb-0">1. Velg <strong>forhåndsfiltre</strong> for å definere ditt søk (dette henter data fra databasen).<br>
            2. Klikk <strong>"Last inn data"</strong>.<br>
            3. Bruk <strong>visningsfiltrene</strong> for å utforske resultatene interaktivt uten å laste inn på nytt.</p>
        </div>

        <h4>1. Forhåndsfiltrer data fra databasen</h4>
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-2"><label for="dropdown-produsent">Produsent</label><select id="dropdown-produsent" class="form-select"><option value="">Alle</option>{% for p in produsenter %}<option value="{{ p }}">{{ p }}</option>{% endfor %}</select></div>
                    <div class="col-md-2"><label for="dropdown-modell">Modell</label><select id="dropdown-modell" class="form-select" disabled></select></div>
                    <div class="col-md-2"><label for="input-startdato">Startdato</label><input type="date" id="input-startdato" class="form-control" value="2025-05-01"></div>
                    <div class="col-md-3"><label for="prefilt-drivstoff">Drivstoff</label><select id="prefilt-drivstoff" class="form-select" multiple>{% for d in drivstoff_opts %}<option value="{{ d }}">{{ d }}</option>{% endfor %}</select></div>
                    <div class="col-md-3"><label for="prefilt-hjuldrift">Hjuldrift</label><select id="prefilt-hjuldrift" class="form-select" multiple>{% for h in hjuldrift_opts %}<option value="{{ h }}">{{ h }}</option>{% endfor %}</select></div>
                </div>
                <div class="row g-3 mb-3">
                    <div class="col-md-2"><label>Årstall</label><div class="input-group"><input type="number" id="prefilt-year-fra" class="form-control" placeholder="{{ year_min }}"><input type="number" id="prefilt-year-til" class="form-control" placeholder="{{ year_max }}"></div></div>
                    <div class="col-md-2"><label>Kjørelengde</label><div class="input-group"><input type="number" id="prefilt-km-fra" class="form-control" placeholder="{{ km_min }}"><input type="number" id="prefilt-km-til" class="form-control" placeholder="{{ km_max }}"></div></div>
                    <div class="col-md-2"><label>Rekkevidde</label><div class="input-group"><input type="number" id="prefilt-range-fra" class="form-control" placeholder="0"><input type="number" id="prefilt-range-til" class="form-control" placeholder="800"></div></div>
                    <div class="col-md-3"><label for="prefilt-modell-sok">Søk i tittel</label><input type="text" id="prefilt-modell-sok" placeholder="F.eks. hengerfeste..." class="form-control"></div>
                    <div class="col-md-3"><label for="prefilt-seller-sok">Selger</label><input type="text" id="prefilt-seller-sok" placeholder="F.eks. Møller..." class="form-control"></div>
                </div>
                <div class="row"><div class="col-md-4"><button id="load-data-button" class="btn btn-primary btn-lg w-100">Last inn data</button></div><div class="col-md-8 align-self-center"><p id="loading-output" class="text-muted mb-0"></p></div></div>
            </div>
        </div>

        <hr class="my-4">
        <div id="results-section" style="display: none;">
            <h2 class="text-center mb-3">Aggregert statistikk</h2>
            <div class="row justify-content-center mb-4" id="kpi-output"></div>
            <div class="row"><div class="col-md-6"><div id="price-line-chart"></div></div><div class="col-md-6"><div id="sold-bar-chart"></div></div></div>
            <hr class="my-4">
            <h2 class="text-center mb-3">2. Utforsk resultater</h2>
            <div class="card mb-4">
                <div class="card-header">Visningsfiltre (filtrerer kun på innlastet data)</div>
                <div class="card-body">
                    <!-- Her legger vi til etter-filtrene -->
                </div>
            </div>
            <p id="antall-biler-funnet" class="text-center fw-bold fs-5 mb-3"></p>
            <div id="output-bil-tabell" class="table-responsive"></div>
        </div>
    </div>

    <script id="models-by-prod-data" type="application/json">{{ models_by_prod | safe }}</script>

    <script>
        // Store for global data
        let fullCarData = [];
        let fullDailyStats = [];

        // Hent alle elementer én gang
        const elements = {
            // ... (kan legge til element-referanser her for bedre ytelse)
        };

        const modelsByProd = JSON.parse(document.getElementById('models-by-prod-data').textContent);

        // Funksjonalitet for avhengige dropdowns
        document.getElementById('dropdown-produsent').addEventListener('change', function() {
            const modellDropdown = document.getElementById('dropdown-modell');
            modellDropdown.innerHTML = '<option value="">Alle</option>';
            const selectedProdusent = this.value;
            if (selectedProdusent && modelsByProd[selectedProdusent]) {
                modelsByProd[selectedProdusent].forEach(m => modellDropdown.add(new Option(m, m)));
                modellDropdown.disabled = false;
            } else {
                modellDropdown.disabled = true;
            }
        });

        // Hovedfunksjon for datainnlasting
        document.getElementById('load-data-button').addEventListener('click', async () => {
            const getVal = id => document.getElementById(id).value || null;
            const getMultiVal = id => Array.from(document.getElementById(id).selectedOptions).map(o => o.value);

            const filters = {
                produsent: getVal('dropdown-produsent'),
                modell: getVal('dropdown-modell'),
                startdato: getVal('input-startdato'),
                drivstoff: getMultiVal('prefilt-drivstoff'),
                hjuldrift: getMultiVal('prefilt-hjuldrift'),
                year_min: getVal('prefilt-year-fra'),
                year_max: getVal('prefilt-year-til'),
                km_min: getVal('prefilt-km-fra'),
                km_max: getVal('prefilt-km-til'),
                range_min: getVal('prefilt-range-fra'),
                range_max: getVal('prefilt-range-til'),
                modell_sok: getVal('prefilt-modell-sok'),
                seller_sok: getVal('prefilt-seller-sok'),
            };

            document.getElementById('loading-spinner').style.display = 'flex';
            document.getElementById('loading-output').textContent = 'Kjører spørring mot Athena... Dette kan ta litt tid.';
            document.getElementById('results-section').style.display = 'none';

            try {
                const response = await fetch('{{ data_url }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filters })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || `Serverfeil: ${response.status}`);
                }

                const data = await response.json();
                fullCarData = data.historikk || [];
                fullDailyStats = data.daily_stats || [];

                document.getElementById('loading-output').textContent = `Lastet inn ${fullCarData.length} bilhistorikker.`;
                document.getElementById('results-section').style.display = 'block';

                updateVisuals();
            } catch (error) {
                console.error("Feil:", error);
                document.getElementById('loading-output').innerHTML = `<span class="text-danger">Feil: ${error.message}</span>`;
            } finally {
                document.getElementById('loading-spinner').style.display = 'none';
            }
        });

        // Sentral funksjon for å oppdatere UI
        function updateVisuals() {
            // Her kommer logikk for etter-filtrering. Foreløpig viser vi alt.
            const filteredData = fullCarData;
            const filteredStats = fullDailyStats;

            updateKPIs(filteredStats);
            updateGraphs(filteredStats);
            updateTable(filteredData);
        }

        function updateKPIs(statsData) {
            const container = document.getElementById('kpi-output');
            container.innerHTML = '';
            if (statsData.length === 0) return;

            const soldCounts = statsData.map(d => d.Antall_Solgt).filter(v => v > 0);
            const prices = statsData.map(d => d.Median_Pris_Usolgt).filter(v => v > 0);

            const avgSold = soldCounts.length > 0 ? (soldCounts.reduce((a, b) => a + b, 0) / soldCounts.length).toFixed(1) : 'N/A';
            const avgPrice = prices.length > 0 ? (prices.reduce((a, b) => a + b, 0) / prices.length).toLocaleString('nb-NO', {style:'currency', currency:'NOK', minimumFractionDigits: 0}) : 'N/A';

            container.innerHTML = `
                <div class="col-md-3"><div class="card text-center"><div class="card-header">Gj.snitt antall solgt per dag</div><div class="card-body"><h4 class="card-title">${avgSold}</h4></div></div></div>
                <div class="col-md-3"><div class="card text-center"><div class="card-header">Gj.snitt medianpris (usolgt)</div><div class="card-body"><h4 class="card-title">${avgPrice}</h4></div></div></div>`;
        }

        function updateGraphs(statsData) {
            const priceDiv = document.getElementById('price-line-chart');
            const soldDiv = document.getElementById('sold-bar-chart');
            if (statsData.length === 0) {
                Plotly.purge(priceDiv); Plotly.purge(soldDiv); return;
            }
            Plotly.newPlot(priceDiv, [{ x: statsData.map(d => d.Dato), y: statsData.map(d => d.Median_Pris_Usolgt), mode: 'lines+markers' }], { title: 'Medianpris over tid (usolgte biler)' });
            Plotly.newPlot(soldDiv, [{ x: statsData.map(d => d.Dato), y: statsData.map(d => d.Antall_Solgt), type: 'bar' }], { title: 'Antall solgte biler per dag' });
        }

        function updateTable(carData) {
            document.getElementById('antall-biler-funnet').textContent = `Antall biler i utvalget: ${carData.length}`;
            const container = document.getElementById('output-bil-tabell');
            container.innerHTML = '';
            if (carData.length === 0) { container.innerHTML = '<div class="alert alert-warning">Ingen biler i utvalget.</div>'; return; }

            const table = document.createElement('table'); table.className = 'table table-striped table-sm table-hover';
            const thead = table.createTHead(); thead.innerHTML = `<tr><th>FINN-kode</th><th>Overskrift</th><th>År</th><th>Km</th><th>Rekkevidde</th><th>Pris</th><th>Prisfall</th><th>Dager</th><th>Drivstoff</th><th>Selger</th></tr>`;

            const tbody = table.createTBody();
            carData.slice(0, 500).forEach(item => { // Begrenser til 500 rader for ytelse
                const row = tbody.insertRow();
                row.insertCell().innerHTML = `<a href="https://www.finn.no/car/used/ad.html?finnkode=${item.finnkode}" target="_blank">${item.finnkode}</a>`;
                row.insertCell().textContent = item.overskrift;
                row.insertCell().textContent = item.årstall;
                row.insertCell().textContent = item.kjørelengde ? item.kjørelengde.toLocaleString('nb-NO') : '';
                row.insertCell().textContent = item.rekkevidde;
                row.insertCell().textContent = item.pris_last ? item.pris_last.toLocaleString('nb-NO') : 'Solgt';
                row.insertCell().textContent = item.prisfall ? item.prisfall.toLocaleString('nb-NO') : '';
                row.insertCell().textContent = item.dager;
                row.insertCell().textContent = item.drivstoff;
                row.insertCell().textContent = item.selger;
            });
            container.appendChild(table);
        }
    </script>
</body>
</html>