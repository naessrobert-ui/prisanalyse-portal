<!DOCTYPE html>
<html lang="nb">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prisanalyse Bolig</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f4f6f8; color: #333; display: flex; flex-direction: column; min-height: 100vh; }
        .main-container { flex: 1; display: flex; position: relative; }
        .side-menu { width: 280px; padding: 20px; background-color: #fff; box-shadow: 2px 0 5px rgba(0,0,0,0.1); display: none; z-index: 10; }
        #map { flex: 1; }
        .landing-page { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('https://images.unsplash.com/photo-1582407947304-fd86f028f716?q=80&w=1992') no-repeat center center; background-size: cover; color: white; padding: 20px; }

        /* *** FIKS: Justert bredde og grid for et penere layout *** */
        .filter-box {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px; /* Redusert fra 900px */
            width: 100%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Redusert fra 220px */
            gap: 20px;
            text-align: left;
        }

        h1, h2, h3 { margin-top: 0; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        select, button, input { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
        .range-group { display: flex; gap: 10px; }
        button { background-color: #0063fb; color: white; cursor: pointer; border: none; font-weight: bold; margin-top: 20px; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: none; align-items: center; justify-content: center; font-size: 24px; z-index: 10000; }
        #home-btn {
            position: absolute;
            top: 20px;
            left: 320px;
            z-index: 1000;
            width: auto;
            padding: 10px 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div id="landing-view" class="landing-page">
        <!-- (Denne HTML-delen er uendret) -->
        <div class="filter-box">
            <h1>Prisanalyse: Boliger for salg i Norge</h1>
            <p>Definer et utvalg for å starte analysen</p>
            <div class="filter-grid">
                <div class="form-group"><label for="fylke-select">Fylke</label><select id="fylke-select"><option>Alle</option>{% for fylke in fylker %}<option value="{{ fylke }}">{{ fylke }}</option>{% endfor %}</select></div>
                <div class="form-group"><label for="status-select">Status</label><select id="status-select"><option>Alle</option><option>Brukt</option><option>Nybygg</option></select></div>
                <div class="form-group"><label for="boligtype-select">Boligtype</label><select id="boligtype-select"><option>Alle</option>{% for type in boligtyper %}<option value="{{ type }}">{{ type }}</option>{% endfor %}</select></div>
                <div class="form-group"><label for="annonsepakke-select">Annonsepakke</label><select id="annonsepakke-select"><option>Alle</option>{% for pakke in annonsepakker %}<option value="{{ pakke }}">{{ pakke }}</option>{% endfor %}</select></div>
                <div class="form-group"><label for="megler-select">Megler</label><select id="megler-select"><option>Alle</option>{% for megler in meglere %}<option value="{{ megler }}">{{ megler }}</option>{% endfor %}</select></div>
                <div class="form-group"><label for="keyword-input">Søk i tittel</label><input type="text" id="keyword-input" placeholder="F.eks. 'Utsikt'"></div>
                <div class="form-group"><label>Totalpris (kr)</label><div class="range-group"><input type="number" id="totalpris_fra" placeholder="Fra"><input type="number" id="totalpris_til" placeholder="Til"></div></div>
                <div class="form-group"><label>M²-pris (kr)</label><div class="range-group"><input type="number" id="m2pris_fra" placeholder="Fra"><input type="number" id="m2pris_til" placeholder="Til"></div></div>
                <div class="form-group"><label>Dager på markedet</label><div class="range-group"><input type="number" id="dager_fra" placeholder="Fra"><input type="number" id="dager_til" placeholder="Til"></div></div>
            </div>
            <button id="start-analysis-btn">Start analyse</button>
        </div>
    </div>

    <div id="analysis-view" class="main-container" style="display: none;">
        <button id="home-btn">← Nytt søk</button>
        <div class="side-menu">
            <h3>Analysevalg</h3>
            <p id="bolig-count"></p>
            <div class="form-group"><label for="color-by-select">Fargelegg etter:</label><select id="color-by-select"><option value="totalpris" selected>Totalpris</option><option value="M2-pris">M²-pris</option><option value="dager_paa_markedet">Dager på markedet</option></select></div>
            <div class="form-group"><label for="low-threshold-input">Grønn hvis verdi &lt;=</label><input type="number" id="low-threshold-input"></div>
            <div class="form-group"><label for="high-threshold-input">Rød hvis verdi &gt;=</label><input type="number" id="high-threshold-input"></div>
            <button id="update-map-btn">Oppdater kart</button>
        </div>
        <div id="map"></div>
    </div>
    <div id="loading-overlay">Laster...</div>

    <script>
        let map;
        let boligData = [];
        let markerClusterGroup;

        const elements = {
            startBtn: document.getElementById('start-analysis-btn'),
            updateBtn: document.getElementById('update-map-btn'),
            homeBtn: document.getElementById('home-btn'),
            colorBySelect: document.getElementById('color-by-select'),
            lowThresholdInput: document.getElementById('low-threshold-input'),
            highThresholdInput: document.getElementById('high-threshold-input'),
            loadingOverlay: document.getElementById('loading-overlay'),
            landingView: document.getElementById('landing-view'),
            analysisView: document.getElementById('analysis-view'),
            sideMenu: document.querySelector('.side-menu'),
            boligCountEl: document.getElementById('bolig-count')
        };

        elements.startBtn.addEventListener('click', fetchInitialData);
        elements.updateBtn.addEventListener('click', () => drawMarkers(false));
        elements.colorBySelect.addEventListener('change', updateThresholdPlaceholders);
        elements.homeBtn.addEventListener('click', goToHome);

        async function fetchInitialData() {
            showLoading("Laster og filtrerer data...");
            const filters = {
                fylke: document.getElementById('fylke-select').value,
                status: document.getElementById('status-select').value,
                boligtype: document.getElementById('boligtype-select').value,
                annonsepakke: document.getElementById('annonsepakke-select').value,
                megler: document.getElementById('megler-select').value,
                keyword: document.getElementById('keyword-input').value,
                totalpris_fra: document.getElementById('totalpris_fra').value,
                totalpris_til: document.getElementById('totalpris_til').value,
                m2pris_fra: document.getElementById('m2pris_fra').value,
                m2pris_til: document.getElementById('m2pris_til').value,
                dager_fra: document.getElementById('dager_fra').value,
                dager_til: document.getElementById('dager_til').value,
            };

            try {
                const response = await fetch('{{ data_url }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filters })
                });
                if (!response.ok) throw new Error(`Server svarte med status ${response.status}`);

                boligData = await response.json();
                if (!boligData || boligData.length === 0) {
                    alert("Fant ingen boliger som matchet dine filterkriterier.");
                    return;
                }

                elements.landingView.style.display = 'none';
                elements.analysisView.style.display = 'flex';
                elements.sideMenu.style.display = 'block';

                if (!map) {
                    map = L.map('map');
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                    }).addTo(map);
                }

                updateThresholdPlaceholders();
                drawMarkers(true);
            } catch (error) {
                console.error("Feil ved henting av data:", error);
                alert("Kunne ikke laste data.");
            } finally {
                hideLoading();
            }
        }

        function drawMarkers(resetView = false) {
            showLoading("Tegner kart...");
            elements.updateBtn.disabled = true;
            setTimeout(() => {
                if (markerClusterGroup) { markerClusterGroup.clearLayers(); }
                else {
                    markerClusterGroup = L.markerClusterGroup({ disableClusteringAtZoom: 13 });
                    map.addLayer(markerClusterGroup);
                }
                const colorBy = elements.colorBySelect.value;
                const lowValue = parseFloat(elements.lowThresholdInput.value);
                const highValue = parseFloat(elements.highThresholdInput.value);
                boligData.forEach(bolig => {
                    if (bolig.latitude == null || bolig.longitude == null) return;
                    const valueForColor = bolig[colorBy];
                    let color = '#808080';
                    if (valueForColor <= lowValue) color = '#008000';
                    if (valueForColor >= highValue) color = '#ff0000';
                    const totalprisMNOK = (bolig.totalpris / 1000000).toFixed(1);
                    const m2prisKTNOK = bolig['M2-pris'] ? Math.round(bolig['M2-pris'] / 1000) : 'N/A';

                    // <-- START ENDRING
                    // Sjekk status-feltet for å bestemme riktig URL-sti for FINN-lenken
                    const finnPath = bolig.status === "Nybygg" ? 'project' : 'homes';
                    const finnUrl = `https://www.finn.no/realestate/${finnPath}/ad.html?finnkode=${bolig.finnkode}`;

                    // Bruk den dynamiske finnUrl i popup-HTML-en
                    const popupHtml = `<b>${bolig.full_title || ''}</b><br><hr><b>Totalpris:</b> ${totalprisMNOK} MNOK<br><b>M²-pris:</b> ${m2prisKTNOK === 'N/A' ? 'N/A' : m2prisKTNOK + ' 000 kr'}<br><b>Dager på markedet:</b> ${bolig.dager_paa_markedet != null ? bolig.dager_paa_markedet : 'N/A'}<br><b>Finnkode:</b> <a href="${finnUrl}" target="_blank">${bolig.finnkode}</a>`;
                    // <-- SLUTT ENDRING

                    const circle = L.circleMarker([bolig.latitude, bolig.longitude], { radius: 5, color: color, fillColor: color, fillOpacity: 0.7 }).bindPopup(popupHtml);
                    markerClusterGroup.addLayer(circle);
                });

                if (resetView && boligData.length > 0) {
                    const bounds = markerClusterGroup.getBounds();
                    if(bounds.isValid()) map.fitBounds(bounds, { padding: [50, 50] });
                } else if (resetView) {
                    map.setView([65.0, 15.0], 5);
                }
                elements.boligCountEl.textContent = `Viser ${boligData.length} boliger.`;
                hideLoading();
                elements.updateBtn.disabled = false;
            }, 50);
        }

        function goToHome() {
            elements.analysisView.style.display = 'none';
            elements.landingView.style.display = 'flex';
            if (map) { map.remove(); map = null; }
            if (markerClusterGroup) { markerClusterGroup = null; }
            boligData = [];
        }

        function updateThresholdPlaceholders() {
            const selected = elements.colorBySelect.value;
            const values = boligData.map(b => b[selected]).filter(v => v != null && !isNaN(v));
            if (values.length > 0) {
                values.sort((a, b) => a - b);
                const lowIndex = Math.floor(values.length * 0.20);
                const highIndex = Math.floor(values.length * 0.80) - 1;
                elements.lowThresholdInput.value = Math.round(values[lowIndex]);
                elements.highThresholdInput.value = Math.round(values[highIndex]);
            }
        }

        function showLoading(message) {
            elements.loadingOverlay.textContent = message;
            elements.loadingOverlay.style.display = 'flex';
        }
        function hideLoading() {
            elements.loadingOverlay.style.display = 'none';
        }
    </script>
</body>
</html>